#!/bin/bash
# If changing this file, relfect the changes in libSPI.sh
# post-install <domainHome> <packageHome>

domainHome=$1
packageHome=$2

# create profiles
packageName=`basename ${packageHome}`
profileDirPath=${packageHome}/etc/profile.d
profilePath=${profileDirPath}/${packageName}.sh
loginPath=${profileDirPath}/${packageName}.csh

rm -f ${profilePath} ${loginPath}
mkdir -p ${profileDirPath}

# Added Intel compiler shared lib path ($INTELCOMP_HOME/lib/intel64_lin)
INTELCOMP_HOME=/fs/ssm/main/opt/intelcomp/intelpsxe-cluster-19.0.3.199/intelpsxe-cluster_19.0.3.199_multi
#INTELCOMP_HOME=/fs/ssm/main/opt/intelcomp/intelcomp-2016.1.156/intelcomp_2016.1.156_multi

# Add EXT package (for various library dependencies)
CMDS_EXT_VERSION=20210210
case `domainname -d` in
   *science.gc.ca)
      EXT_HOME=eccc/cmd/cmds/ext/${CMDS_EXT_VERSION}
      ;;
   *ec.gc.ca)
      EXT_HOME=cmds/ext/${CMDS_EXT_VERSION}
      ;;
   *)
      EXT_HOME=NIL
      echo "(WARNING) Not running on GC network, external dependency package ${CMDS_EXT_VERSION} not loaded"
      ;;
esac

cat > ${profilePath} << EOF
export EC_INCLUDE_PATH="${packageHome}/include \${EC_INCLUDE_PATH}"
export EC_LD_LIBRARY_PATH="${packageHome}/lib \${EC_LD_LIBRARY_PATH}"
export LD_LIBRARY_PATH="${packageHome}/lib:${INTELCOMP_HOME}/lib/intel64_lin:\${LD_LIBRARY_PATH}"

#----- Add the <PackageName>_DIR variable for cmake builds
export ${packageName%%_*}_DIR="$packageHome"

#----- Load SSM dependencies
[[ \${LD_LIBRARY_PATH} =~ ${EXT_HOME} ]] || . ssmuse-sh -d ${EXT_HOME}
EOF

cat > ${loginPath} << EOF
setenv EC_INCLUDE_PATH="${packageHome}/include \${EC_INCLUDE_PATH}" 
setenv EC_LD_LIBRARY_PATH="${packageHome}/lib \${EC_LD_LIBRARY_PATH}" 
setenv LD_LIBRARY_PATH="${packageHome}/lib:${INTELCOMP_HOME}/lib/intel64_lin:\${LD_LIBRARY_PATH}"

#----- Add the <PackageName>_DIR variable for cmake builds
export ${packageName%%_*}_DIR="$packageHome"

#----- Load SSM dependencies
[[ \${LD_LIBRARY_PATH} =~ ${EXT_HOME} ]] || . ssmuse-sh -d ${EXT_HOME}
EOF
